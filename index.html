https://bowiespy-hub.github.io/geminicode/<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>ATE - SPY Evolution</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Manrope:wght@200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round|Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Manrope"', '"Noto Sans TC"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                        display: ['"Playfair Display"', '"Noto Sans TC"', 'serif'],
                    },
                    colors: {
                        primary: "#D4AF37", 
                        "primary-glow": "#F9E076",
                        obsidian: "#0A0A0F",
                        "obsidian-light": "#1A1A24",
                        "indigo-deep": "#0F0F2D",
                        "indigo-glow": "#4B0082",
                        "background-dark": "#050508",
                        "violet-glow": "#8B5CF6",
                        "accent-purple": "#A894F8",
                        "accent-blue": "#4a5cd8",
                    },
                    backgroundImage: {
                        'glass-gradient': 'linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%)',
                        'gold-gradient': 'linear-gradient(45deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C)',
                        'bar-gradient': 'linear-gradient(90deg, #F59E0B 0%, #FCD34D 50%, #FFFBEB 100%)',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                        'glow-gold': '0 0 20px rgba(212, 175, 55, 0.4)',
                        'glow-blue': '0 0 15px rgba(59, 130, 246, 0.4)',
                        'glow-purple': '0 0 15px rgba(168, 85, 247, 0.4)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fadeIn': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                },
            },
        };
    </script>

    <style>
        body {
            background-color: #050508;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            color: #E2E8F0;
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container { position: relative; max-width: 430px; margin: 0 auto; height: 100dvh; display: flex; flex-direction: column; z-index: 10; background: rgba(0,0,0,0.2); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 120px; scrollbar-width: none; }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* Glass Utilities */
        .glass-panel {
            background: rgba(20, 20, 30, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }
        .press:active { transform: scale(0.97); }
        
        .glass-modal {
            background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        /* Glow Text */
        .text-glow { text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
        .gold-text-glow { text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); }

        /* SVG Timer */
        .timer-circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 6; }
        .timer-circle-progress {
            fill: none; stroke: url(#gradientStroke); stroke-width: 6; stroke-linecap: round;
            stroke-dasharray: 880; stroke-dashoffset: 880; 
            transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 12px rgba(212, 175, 55, 0.6));
        }

        /* Nav */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px 16px 24px 16px; z-index: 50; display: flex; justify-content: space-around;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #64748b; font-size: 10px; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: #D4AF37; }
        .nav-item .material-icons-round { font-size: 24px; transition: 0.3s; }
        .nav-item.active .material-icons-round { filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.5)); transform: translateY(-2px); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-sheet { width: 100%; max-width: 430px; border-radius: 32px 32px 0 0; padding: 24px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid rgba(255,255,255,0.1); }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }

        /* XP FX */
        .xp-float { position: fixed; z-index: 999; pointer-events: none; font-weight: 800; font-family: 'Playfair Display', serif; font-size: 24px; text-shadow: 0 4px 15px rgba(0,0,0,0.8); transform: translate(-50%, -50%); opacity: 0; animation: floatUp 1s ease-out forwards; }
        .xp-plus { color: #F9E076; }
        .xp-minus { color: #ef4444; }
        @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 0) scale(0.9); } 20% { opacity: 1; transform: translate(-50%, -15px) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -50px) scale(1); } }

        /* Custom Inputs */
        input, textarea { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 14px; border-radius: 16px; font-family: inherit; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus, textarea:focus { border-color: #D4AF37; background: rgba(212, 175, 55, 0.05); }

        .view-section { display: none; opacity: 0; animation: fadeIn 0.4s forwards; }
        .view-section.active { display: flex; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Hidden File Input for Avatar Upload -->
        <input type="file" id="avatarUpload" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
        
        <!-- DYNAMIC CONTENT -->
        <div id="main-view" class="scroll-area"></div>

        <!-- NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="router('hub')" id="nav-hub">
                <span class="material-icons-round">rocket_launch</span><span>進化</span>
            </div>
            <div class="nav-item" onclick="router('body')" id="nav-body">
                <span class="material-icons-round">fitness_center</span><span>身體</span>
            </div>
            <div class="nav-item" onclick="router('mind')" id="nav-mind">
                <span class="material-icons-round">psychology</span><span>心智</span>
            </div>
            <div class="nav-item" onclick="router('cal')" id="nav-cal">
                <span class="material-icons-round">calendar_today</span><span>日曆</span>
            </div>
        </div>
    </div>

    <!-- MODAL: TIMER -->
    <div class="modal-overlay" id="timer-modal">
        <div class="modal-sheet glass-modal relative overflow-hidden">
            <div class="absolute -top-20 -right-20 w-64 h-64 bg-violet-glow/20 rounded-full blur-[80px]"></div>
            
            <div class="flex justify-between items-center mb-8 relative z-10">
                <div class="text-xs tracking-widest text-gray-400 uppercase font-bold" id="timer-label">FOCUS SESSION</div>
                <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center press" onclick="closeModal('timer-modal')">
                    <span class="material-icons-round text-sm">close</span>
                </button>
            </div>
            
            <h2 id="timer-title" class="text-center text-2xl font-display text-white mb-8 relative z-10">Task</h2>
            
            <div class="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center relative z-10">
                <div class="absolute inset-0 rounded-full border border-violet-500/10 shadow-[0_0_40px_rgba(139,92,246,0.1)]"></div>
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 300 300">
                    <defs>
                        <linearGradient id="gradientStroke" x1="0%" x2="100%" y1="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#8B5CF6; stop-opacity:1"></stop>
                            <stop offset="50%" style="stop-color:#D4AF37; stop-opacity:1"></stop>
                            <stop offset="100%" style="stop-color:#8B5CF6; stop-opacity:1"></stop>
                        </linearGradient>
                    </defs>
                    <circle class="timer-circle-bg" cx="150" cy="150" r="140"></circle>
                    <circle id="timer-svg-prog" class="timer-circle-progress" cx="150" cy="150" r="140"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                    <div class="text-6xl font-light text-white font-display tracking-tighter tabular-nums drop-shadow-lg" id="timer-display">00:00</div>
                </div>
            </div>
            
            <div class="flex gap-4 relative z-10">
                <button class="flex-1 bg-gradient-to-r from-[#D4AF37] to-[#F2D06B] text-black font-bold py-4 rounded-2xl shadow-glow-gold press flex items-center justify-center gap-2" id="timer-toggle-btn" onclick="toggleTimerState()">
                    <span class="material-icons-round" id="timer-icon">play_arrow</span>
                    <span id="timer-text">開始</span>
                </button>
                <button class="w-16 bg-white/10 text-white rounded-2xl flex items-center justify-center press" onclick="resetTimer()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: DAY DETAIL -->
    <div class="modal-overlay" id="day-modal">
        <div class="modal-sheet glass-modal">
            <div class="flex justify-between items-center mb-6">
                <h2 id="day-modal-title" class="text-2xl font-display text-primary gold-text-glow">Date</h2>
                <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center press" onclick="closeModal('day-modal')">
                    <span class="material-icons-round text-sm">close</span>
                </button>
            </div>
            <div id="day-modal-content" class="space-y-4"></div>
            <button class="w-full mt-6 py-4 rounded-xl border border-primary/50 text-primary font-bold tracking-wide press bg-primary/5 hover:bg-primary/10 transition-colors" onclick="setActiveDayFromModal()">
                編輯此日紀錄 (補登)
            </button>
        </div>
    </div>

    <script>
        /* =========================================
           ATE V16+ - DAILY SCRIPTURE & AVATAR UPLOAD
        ========================================= */
        const DB_KEY = 'ATE_OBSIDIAN_V16';
        const WATER_TARGET = 1900;
        
        const META = {
            squat: { title: "大師深蹲 (15m)", xp: 60, icon: "fitness_center", type: "timer", dur: 15*60 },
            resist: { title: "阻力訓練 (30m)", xp: 80, icon: "exercise", type: "timer", dur: 30*60 },
            breakfast: { title: "DIAAS 早餐", xp: 30, icon: "restaurant", type: "check" },
            read: { title: "深度閱讀 (20m)", xp: 70, icon: "menu_book", type: "timer", dur: 20*60 },
            devotion: { title: "靜默靈修 (10m)", xp: 60, icon: "spa", type: "timer", dur: 10*60 },
            bowel: { xp: 20 },
            notes: { growth: 40, brand: 40, scripture: 30, spirit: 50, journal: 30 },
            waterGoal: 100 
        };

        // Hand-picked verses for Daily Manna
        const VERSES = [
            { text: "I can do all things through him who strengthens me.", ref: "Philippians 4:13" },
            { text: "For God gave us a spirit not of fear but of power and love and self-control.", ref: "2 Timothy 1:7" },
            { text: "Commit your work to the Lord, and your plans will be established.", ref: "Proverbs 16:3" },
            { text: "Be strong and courageous. Do not be frightened, and do not be dismayed, for the Lord your God is with you wherever you go.", ref: "Joshua 1:9" },
            { text: "But they who wait for the Lord shall renew their strength; they shall mount up with wings like eagles...", ref: "Isaiah 40:31" },
            { text: "Let all that you do be done in love.", ref: "1 Corinthians 16:14" },
            { text: "Trust in the Lord with all your heart, and do not lean on your own understanding.", ref: "Proverbs 3:5" },
            { text: "The steadfast love of the Lord never ceases; his mercies never come to an end; they are new every morning.", ref: "Lamentations 3:22-23" },
            { text: "Peace I leave with you; my peace I give to you. Not as the world gives do I give to you. Let not your hearts be troubled.", ref: "John 14:27" },
            { text: "And let us not grow weary of doing good, for in due season we will reap, if we do not give up.", ref: "Galatians 6:9" }
        ];

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
        let activeDate = getTodayStr(); 
        let timerObj = { id: null, rem: 0, total: 0, interval: null, running: false };

        function getTodayStr() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function initDB() {
            if (!db.settings) db.settings = { userName: "覺醒女神", avatarUrl: "https://lh3.googleusercontent.com/aida-public/AB6AXuCAYOzNGEzdDG66QmmNGCUlkdnwk7zJo0-6al0p4StVVrRy7UvwIFfnSbzk1yro93SGmClDJXzHkeK0f3pOKlJ7_0wH9VzNbQ3ATQRP2P4Msi2j3L88v-cPqgWfProkys6HXeVgnOq9poVFtfNyxvn9pqj2xho4IOb0kutPRkMrNn2qgl6IG3CfgZJFN6h_2N_KyQQzgP3uX0T6tGAkUnEDgaVjHUIXMZVxocw3H1i2okCF0BovjWGbicSrh5A42xuvBTiOpnUCuI0" };
            if (!db.gamify) db.gamify = { combo: 1, lastActive: 0 };
            if (!db.logs) db.logs = {};
        }

        function initDate(dateStr) {
            if (!db.logs[dateStr]) {
                db.logs[dateStr] = {
                    water: 0, bowel: false,
                    tasks: { squat: false, resist: false, read: false, breakfast: false, devotion: false },
                    notes: { growth: "", brand: "", scripture: "", spirit: "", journal: "" }
                };
                saveDB();
            }
        }

        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

        function resetAll() {
            if(confirm("【系統重置警告】確定要清除所有數據並從 0 開始嗎？")) {
                localStorage.removeItem(DB_KEY); location.reload();
            }
        }

        // Handle Image Upload & Compression (Avoid LocalStorage bloat)
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 300px width/height for localstorage safety
                    const MAX_SIZE = 300;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height *= MAX_SIZE / width;
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width *= MAX_SIZE / height;
                            height = MAX_SIZE;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    db.settings.avatarUrl = canvas.toDataURL('image/jpeg', 0.8);
                    saveDB();
                    renderView(); // Refresh to show new avatar
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function triggerAvatarUpload() {
            document.getElementById('avatarUpload').click();
        }

        function isPerfect(dateStr) {
            const d = db.logs[dateStr];
            if(!d || !d.tasks) return false;
            return (d.water >= WATER_TARGET) && d.tasks.squat && d.tasks.resist && d.tasks.breakfast;
        }

        // --- XP & STREAK ---
        function calcStreak() {
            let streak = 0;
            const today = new Date();
            for (let i=0; i<365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
                
                const d = db.logs[dateStr];
                let isActive = false;
                if (d) {
                    const tasksDone = Object.values(d.tasks).some(v => v);
                    const notesWritten = Object.values(d.notes).some(v => v.trim() !== "");
                    isActive = (d.water > 0) || tasksDone || notesWritten || d.bowel;
                }
                if (isActive) streak++;
                else if (i > 0) break;
            }
            return streak;
        }

        function calcTotalXP() {
            let total = 0;
            Object.keys(db.logs).forEach(date => {
                const d = db.logs[date];
                if(!d || !d.tasks) return; 
                
                if(d.tasks.squat) total += META.squat.xp;
                if(d.tasks.resist) total += META.resist.xp;
                if(d.tasks.read) total += META.read.xp;
                if(d.tasks.breakfast) total += META.breakfast.xp;
                if(d.tasks.devotion) total += META.devotion.xp;
                if(d.bowel) total += META.bowel.xp;
                
                if(d.notes.growth?.trim()) total += META.notes.growth;
                if(d.notes.brand?.trim()) total += META.notes.brand;
                if(d.notes.scripture?.trim()) total += META.notes.scripture;
                if(d.notes.spirit?.trim()) total += META.notes.spirit;
                if(d.notes.journal?.trim()) total += META.notes.journal;
                
                if(d.water >= WATER_TARGET) total += META.waterGoal;
                total += Math.floor(d.water / 500) * 10; 
            });
            return total;
        }

        function updateName(newName) {
            if(newName.trim() !== "") {
                db.settings.userName = newName.trim();
                saveDB();
            }
        }

        // --- ACTIONS (Stateless) ---
        function actionWrapper(fn, event, isPositiveAction) {
            const oldXP = calcTotalXP();
            const now = Date.now();
            
            if (isPositiveAction) {
                if (now - db.gamify.lastActive <= 5 * 60 * 1000) db.gamify.combo = Math.min(db.gamify.combo + 1, 5); 
                else db.gamify.combo = 1;
                db.gamify.lastActive = now;
            }

            fn();
            saveDB();
            
            const newXP = calcTotalXP();
            const diff = newXP - oldXP;
            
            if(diff !== 0 && event && event.currentTarget) {
                const rect = event.currentTarget.getBoundingClientRect();
                showFloatingXP(diff, rect.left + rect.width / 2, rect.top, db.gamify.combo);
            }
            refreshUI(); 
        }

        function modWater(amount, event) {
            if (db.logs[activeDate].water + amount < 0) return;
            actionWrapper(() => { db.logs[activeDate].water += amount; }, event, amount > 0);
        }

        function toggleBowel(event) {
            const willBeTrue = !db.logs[activeDate].bowel;
            actionWrapper(() => { db.logs[activeDate].bowel = willBeTrue; }, event, willBeTrue);
        }

        function toggleTask(id, event) {
            const willBeTrue = !db.logs[activeDate].tasks[id];
            actionWrapper(() => { db.logs[activeDate].tasks[id] = willBeTrue; }, event, willBeTrue);
        }

        function saveNote(type, val) {
            const wasEmpty = db.logs[activeDate].notes[type].trim() === "";
            const isEmpty = val.trim() === "";
            actionWrapper(() => { db.logs[activeDate].notes[type] = val; }, null, !isEmpty);
        }

        // --- TARGETED UI REFRESH (Zero Flicker) ---
        function updateEl(id, val) { const el = document.getElementById(id); if(el) el.innerHTML = val; }
        function updateStyle(id, prop, val) { const el = document.getElementById(id); if(el) el.style[prop] = val; }

        function refreshUI() {
            const data = db.logs[activeDate];
            const xp = calcTotalXP();
            const level = Math.floor(xp / 500) + 1;
            const xpPct = ((xp % 500) / 500) * 100;
            const currentStreak = calcStreak();
            
            const bTasks = (data.tasks.squat?1:0) + (data.tasks.resist?1:0) + (data.tasks.breakfast?1:0);
            const wScore = Math.min(data.water/WATER_TARGET, 1) * 100;
            const bScore = Math.round((wScore * 0.4) + ((bTasks/3)*100 * 0.6));

            // View: Hub
            updateEl('hub-bscore', `${bScore}%`);
            updateStyle('hub-bbar', 'width', `${bScore}%`);
            updateEl('hub-level', level);
            updateEl('hub-xp-text', `${xp} / ${level*500} XP`);
            updateStyle('hub-xp-bar', 'width', `${xpPct}%`);
            updateEl('hub-streak', currentStreak);

            // View: Body
            if(document.getElementById('water-val')) {
                updateEl('water-val', data.water);
                updateStyle('water-bar', 'height', `${wScore}%`); 
                
                ['squat', 'resist', 'breakfast'].forEach(id => {
                    updateEl(`task-${id}`, buildTaskInner(id));
                });
                
                const bTog = document.getElementById('bowel-toggle');
                if(bTog) {
                    bTog.className = `w-14 h-8 rounded-full relative transition-colors duration-300 border border-white/10 ${data.bowel ? 'bg-primary' : 'bg-gray-700/50'}`;
                    bTog.children[0].style.transform = data.bowel ? 'translateX(24px)' : 'translateX(0)';
                }
            }

            // View: Mind
            if(document.getElementById('task-read')) {
                updateEl('task-read', buildTaskInner('read', true));
                updateEl('task-devotion', buildTaskInner('devotion', true));
            }

            // View: Calendar
            if (currentView === 'cal') renderCalendarGrid();
        }

        // --- ROUTER & RENDER ---
        let currentView = 'hub';
        
        function router(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            renderView();
        }

        function renderView() {
            const main = document.getElementById('main-view');
            initDB(); initDate(activeDate);
            const data = db.logs[activeDate];
            const xp = calcTotalXP();
            const level = Math.floor(xp / 500) + 1;
            const nextXP = level * 500;
            const xpPct = ((xp % 500) / 500) * 100;
            const currentStreak = calcStreak();
            
            const bTasks = (data.tasks.squat?1:0) + (data.tasks.resist?1:0) + (data.tasks.breakfast?1:0);
            const wScore = Math.min(data.water/WATER_TARGET, 1) * 100;
            const bScore = Math.round((wScore * 0.4) + ((bTasks/3)*100 * 0.6));
            
            let html = '';

            if (currentView === 'hub') {
                // Get Daily Verse
                const todayNum = new Date(activeDate).getDate();
                const verse = VERSES[todayNum % VERSES.length];

                html = `
                    <header class="px-2 py-4 flex justify-between items-center relative z-10 mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="material-icons-round text-primary/80 text-lg">nightlight_round</span>
                            <span class="text-sm tracking-widest uppercase text-gray-400 font-light">EVOLUTION</span>
                            <span class="material-icons-round text-gray-600 text-[14px] ml-1 cursor-pointer hover:text-red-400 transition-colors" onclick="resetAll()" title="Reset Database">refresh</span>
                        </div>
                        <div class="w-11 h-11 rounded-xl border border-white/20 flex items-center justify-center overflow-hidden press shadow-glow cursor-pointer" onclick="triggerAvatarUpload()" title="更換頭像">
                            <img alt="Profile" class="w-full h-full object-cover" src="${db.settings.avatarUrl}"/>
                        </div>
                    </header>

                    <div class="text-center space-y-1 mb-8 mt-2">
                        <h1 class="text-3xl font-serif tracking-wide text-white text-glow">
                            Welcome, <span class="editable-name" contenteditable="true" onblur="updateName(this.innerText)">${db.settings.userName}</span>
                        </h1>
                        <p class="text-xs text-primary font-light tracking-[0.2em] uppercase opacity-80">Evolution Checkpoint</p>
                    </div>

                    <!-- Daily Manna (Verse) -->
                    <div class="glass-panel rounded-[24px] p-5 mb-6 relative overflow-hidden" style="border-color: rgba(212, 175, 55, 0.2);">
                        <div class="absolute -right-2 -top-6 text-[100px] opacity-5 font-serif text-gold leading-none pointer-events-none">"</div>
                        <div class="text-[10px] text-gold uppercase tracking-widest mb-3 flex items-center gap-1.5"><span class="material-icons-round text-[14px]">auto_stories</span> Daily Manna</div>
                        <p class="font-serif text-[15px] leading-relaxed text-gray-200 italic relative z-10">"${verse.text}"</p>
                        <div class="text-right mt-3 text-[11px] text-primary/80 font-bold tracking-widest uppercase">— ${verse.ref}</div>
                    </div>

                    <div class="glass-panel rounded-[32px] p-6 mb-6 relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-primary/20 rounded-full blur-[50px]"></div>
                        <div class="text-center space-y-1 relative z-10 mb-6">
                            <h2 class="text-gray-300 text-sm font-medium tracking-wider">Evolution Level</h2>
                            <h1 class="text-5xl font-display text-transparent bg-clip-text bg-gradient-to-b from-amber-100 to-amber-500 gold-text-glow" id="hub-level">${level}</h1>
                        </div>
                        <div class="w-full space-y-2 relative z-10">
                            <div class="h-3 w-full bg-black/40 rounded-full overflow-hidden border border-white/5 shadow-inner">
                                <div id="hub-xp-bar" class="h-full bg-bar-gradient shadow-glow-gold rounded-full relative" style="width:${xpPct}%"></div>
                            </div>
                            <div class="flex justify-between text-[11px] text-gray-400 font-medium px-1 uppercase tracking-wider">
                                <span id="hub-xp-text">${xp} / ${nextXP} XP</span>
                                <span>Combo x${db.gamify.combo}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="glass-panel rounded-[24px] p-5 press cursor-pointer" onclick="router('body')">
                            <span class="material-icons-round text-blue-400 mb-2 block">vital_signs</span>
                            <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Body Score</div>
                            <div class="text-2xl font-bold text-white mb-2" id="hub-bscore">${bScore}%</div>
                            <div class="h-1.5 w-full bg-black/40 rounded-full overflow-hidden"><div id="hub-bbar" class="h-full bg-blue-500 rounded-full" style="width:${bScore}%"></div></div>
                        </div>
                        <div class="glass-panel rounded-[24px] p-5 press cursor-pointer" onclick="router('cal')">
                            <span class="material-icons-round text-primary mb-2 block">local_fire_department</span>
                            <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Current Streak</div>
                            <div class="text-2xl font-bold text-primary gold-text-glow" id="hub-streak">${currentStreak}</div>
                            <div class="text-[10px] text-gray-500 mt-2">Active Days</div>
                        </div>
                    </div>

                    <div class="glass-panel rounded-[24px] p-5 mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-icons-round text-primary text-sm">edit</span>
                            <span class="text-xs font-bold text-gray-300 uppercase tracking-widest">Daily Journal</span>
                        </div>
                        <textarea class="w-full bg-black/20 border border-white/5 rounded-xl p-4 text-sm text-gray-200 resize-none h-24 focus:border-primary/50 outline-none transition-colors" placeholder="寫下今天的一句話，總結你的進化..." onblur="saveNote('journal', this.value)">${data.notes.journal}</textarea>
                    </div>
                `;
            } 
            
            else if (currentView === 'body') {
                html = `
                    <header class="px-2 py-4 mb-2">
                        <h1 class="text-3xl font-serif text-white text-glow mb-1">身體進化</h1>
                        <p class="text-xs text-primary font-light tracking-[0.2em] uppercase opacity-80">${activeDate === getTodayStr() ? 'TODAY' : activeDate}</p>
                    </header>

                    <!-- Beaker Water UI -->
                    <div class="glass-panel rounded-[32px] p-6 mb-6">
                        <div class="flex justify-between items-start mb-6">
                            <div><div class="text-xs text-gray-400 uppercase tracking-widest mb-1">Hydration</div><div class="text-3xl font-display text-white" id="water-val">${data.water}</div></div>
                            <div class="px-3 py-1 bg-blue-500/20 border border-blue-500/30 rounded-full text-blue-300 text-[10px] font-bold tracking-wider">${WATER_TARGET} ML</div>
                        </div>
                        
                        <div class="relative w-[120px] h-[180px] mx-auto bg-white/5 rounded-[10px_10px_30px_30px] border-2 border-white/20 border-t-0 overflow-hidden mb-6 shadow-glow-blue">
                            <div class="absolute -top-[5px] -left-[2px] -right-[2px] h-[15px] border-2 border-white/30 rounded-full z-10"></div>
                            <div id="water-bar" class="absolute bottom-0 left-0 right-0 w-full bg-gradient-to-t from-blue-600 to-blue-400 opacity-80 transition-all duration-500" style="height:${wScore}%"></div>
                        </div>

                        <div class="flex gap-3">
                            <button class="flex-1 py-3 glass-panel rounded-xl text-blue-300 border border-blue-500/30 font-bold text-sm press flex justify-center items-center gap-1" onclick="modWater(250, event)"><span class="material-icons-round text-base">add</span>250</button>
                            <button class="flex-1 py-3 bg-blue-600 text-white rounded-xl shadow-glow-blue font-bold text-sm press flex justify-center items-center gap-1" onclick="modWater(500, event)"><span class="material-icons-round text-base">add</span>500</button>
                            <button class="w-12 py-3 bg-red-500/20 text-red-400 border border-red-500/30 rounded-xl font-bold press flex justify-center items-center" onclick="modWater(-250, event)"><span class="material-icons-round text-base">remove</span></button>
                        </div>
                    </div>

                    <h3 class="text-xs text-gray-400 uppercase tracking-widest mb-3 pl-2">Training & Health</h3>
                    <div class="space-y-3 mb-6">
                        <div id="task-squat">${buildTaskInner('squat')}</div>
                        <div id="task-resist">${buildTaskInner('resist')}</div>
                        <div id="task-breakfast">${buildTaskInner('breakfast')}</div>
                    </div>

                    <div class="glass-panel rounded-2xl p-5 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-purple-500/20 text-purple-300 flex items-center justify-center"><span class="material-icons-round">gastroenterology</span></div>
                            <div><h4 class="font-bold text-white text-sm">排便確認</h4><p class="text-xs text-gray-500">Daily Health</p></div>
                        </div>
                        <div id="bowel-toggle" class="w-14 h-8 rounded-full relative transition-colors duration-300 cursor-pointer border border-white/10 ${data.bowel ? 'bg-primary' : 'bg-gray-700/50'}" onclick="toggleBowel(event)">
                            <div class="absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform duration-300 shadow-md" style="transform: ${data.bowel ? 'translateX(24px)' : 'translateX(0)'}"></div>
                        </div>
                    </div>
                `;
            }

            else if (currentView === 'mind') {
                html = `
                    <header class="px-2 py-4 mb-2">
                        <h1 class="text-3xl font-serif text-white text-glow mb-1">心智與靈魂</h1>
                        <p class="text-xs text-primary font-light tracking-[0.2em] uppercase opacity-80">${activeDate === getTodayStr() ? 'TODAY' : activeDate}</p>
                    </header>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div id="task-read">${buildTaskInner('read', true)}</div>
                        <div id="task-devotion">${buildTaskInner('devotion', true)}</div>
                    </div>

                    <div class="glass-panel rounded-3xl p-5 mb-4">
                        <h3 class="text-xs text-primary-glow uppercase tracking-widest mb-3 flex items-center gap-2"><span class="material-icons-round text-sm">diamond</span> Brand Strategy</h3>
                        <textarea class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white resize-none h-24 focus:border-primary/50 outline-none" placeholder="今日品牌策略與靈感..." onblur="saveNote('brand', this.value)">${data.notes.brand}</textarea>
                    </div>

                    <div class="glass-panel rounded-3xl p-5 mb-6">
                        <h3 class="text-xs text-primary-glow uppercase tracking-widest mb-3 flex items-center gap-2"><span class="material-icons-round text-sm">psychology</span> Growth Reflection</h3>
                        <input type="text" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white focus:border-primary/50 outline-none" placeholder="今天學到了什麼？" value="${data.notes.growth}" onblur="saveNote('growth', this.value)">
                    </div>

                    <div class="glass-panel rounded-3xl p-5 border-t border-gold/30">
                        <h3 class="text-xs text-gold uppercase tracking-widest mb-3 flex items-center gap-2"><span class="material-icons-round text-sm">auto_stories</span> Spirit & Scripture</h3>
                        <input type="text" class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-gold/50 outline-none mb-3" placeholder="Verse (e.g. 詩篇 23:1)" value="${data.notes.scripture}" onblur="saveNote('scripture', this.value)">
                        <textarea class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white resize-none h-24 focus:border-gold/50 outline-none" placeholder="靈修心得與領受..." onblur="saveNote('spirit', this.value)">${data.notes.spirit}</textarea>
                    </div>
                `;
            }

            else if (currentView === 'cal') {
                const d = new Date(activeDate);
                const year = d.getFullYear(), month = d.getMonth();
                const monthName = ["January","February","March","April","May","June","July","August","September","October","November","December"][month];
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();

                let gridHtml = '';
                for(let i=0; i<firstDay; i++) gridHtml += `<div></div>`;
                
                for(let i=1; i<=daysInMonth; i++) {
                    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const dayData = db.logs[dateKey];
                    const perfect = dayData ? isPerfect(dateKey) : false;
                    const today = dateKey === getTodayStr();
                    const selected = dateKey === activeDate;
                    
                    let className = 'aspect-square rounded-xl flex items-center justify-center font-bold text-sm relative cursor-pointer press transition-colors ';
                    if (perfect) className += 'bg-gradient-to-br from-primary to-orange-500 text-white shadow-glow-gold border-none';
                    else if (selected) className += 'border-2 border-white bg-white/10 text-white';
                    else if (today) className += 'border border-primary text-primary';
                    else className += 'bg-white/5 border border-white/5 text-gray-400 hover:bg-white/10';
                    
                    const hasData = dayData && (dayData.water>0 || dayData.tasks.squat || dayData.notes.growth);
                    const dot = hasData && !perfect ? `<div class="absolute bottom-1.5 w-1 h-1 bg-accent-blue rounded-full"></div>` : '';

                    gridHtml += `<div class="${className}" onclick="openDayDetail('${dateKey}')">${i}${dot}</div>`;
                }

                html = `
                    <header class="px-2 py-4 mb-2 text-center">
                        <h1 class="text-3xl font-serif text-white text-glow mb-1">進化歷程</h1>
                        <p class="text-xs text-primary font-light tracking-[0.2em] uppercase opacity-80">Evolution Log</p>
                    </header>
                    
                    <div class="glass-panel rounded-[32px] p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <button class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center press hover:bg-white/10" onclick="changeMonth(-1)"><span class="material-icons-round text-white">chevron_left</span></button>
                            <h2 class="text-xl font-display text-white tracking-widest">${monthName} ${year}</h2>
                            <button class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center press hover:bg-white/10" onclick="changeMonth(1)"><span class="material-icons-round text-white">chevron_right</span></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center text-[10px] text-gray-500 font-bold mb-4">
                            <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                        </div>
                        <div class="grid grid-cols-7 gap-2" id="cal-grid">${gridHtml}</div>
                        <div class="text-center text-xs text-gray-500 mt-6">點擊日期查看詳細紀錄或補登</div>
                    </div>
                `;
            }

            main.innerHTML = html;
            main.className = `scroll-area active`; 
        }

        // --- UI BUILDERS ---
        function buildTaskInner(id, isGrid = false) {
            const isDone = db.logs[activeDate].tasks[id];
            const m = META[id];
            
            if (isGrid) {
                return `
                <div class="glass-panel rounded-3xl p-5 flex flex-col h-36 relative overflow-hidden transition-all duration-300 ${isDone ? 'border-primary/50 shadow-glow-gold' : ''}">
                    ${isDone ? '<div class="absolute inset-0 bg-primary/10"></div>' : ''}
                    <div class="relative z-10 flex justify-between items-start mb-auto">
                        <div class="w-10 h-10 rounded-full ${isDone ? 'bg-primary text-background-dark' : 'bg-white/5 text-gray-400'} flex items-center justify-center transition-colors"><span class="material-icons-round text-xl">${m.icon}</span></div>
                        ${m.type === 'timer' && !isDone ? `<button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center press" onclick="openTimer('${id}')"><span class="material-icons-round text-sm">play_arrow</span></button>` : ''}
                    </div>
                    <div class="relative z-10 flex items-end justify-between">
                        <div><h4 class="font-bold text-white text-sm">${m.title.split(' ')[0]}</h4><p class="text-[10px] text-gray-400">${isDone ? 'Completed' : `+${m.xp} XP`}</p></div>
                        <button class="w-8 h-8 rounded-full border flex items-center justify-center press transition-colors ${isDone ? 'bg-transparent border-primary text-primary' : 'border-white/20 text-gray-400 hover:bg-white/10'}" onclick="toggleTask('${id}', event)"><span class="material-icons-round text-sm">${isDone ? 'check' : 'check'}</span></button>
                    </div>
                </div>`;
            }

            return `
            <div class="glass-panel rounded-2xl p-4 flex items-center justify-between transition-all duration-300 ${isDone ? 'border-primary/50 shadow-[0_0_15px_rgba(212,175,55,0.15)] bg-gradient-to-r from-primary/10 to-transparent' : ''}">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center transition-colors ${isDone ? 'bg-primary text-background-dark shadow-glow-gold' : 'bg-white/5 text-gray-400'}"><span class="material-icons-round">${m.icon}</span></div>
                    <div><h4 class="font-bold text-white text-sm ${isDone ? 'line-through opacity-70' : ''}">${m.title}</h4><p class="text-xs ${isDone ? 'text-primary' : 'text-gray-500'}">${isDone ? 'Completed' : `+${m.xp} XP`}</p></div>
                </div>
                <div class="flex gap-2">
                    ${m.type === 'timer' && !isDone ? `<button class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white press hover:bg-white/20" onclick="openTimer('${id}')"><span class="material-icons-round">play_arrow</span></button>` : ''}
                    <button class="w-10 h-10 rounded-full border flex items-center justify-center press transition-colors ${isDone ? 'bg-transparent border-primary text-primary' : 'border-white/20 text-gray-400 hover:bg-white/10'}" onclick="toggleTask('${id}', event)"><span class="material-icons-round">${isDone ? 'undo' : 'check'}</span></button>
                </div>
            </div>`;
        }

        // --- TIMER ---
        function openTimer(id) {
            const dur = META[id].dur;
            timerObj = { id, rem: dur, total: dur, running: false, interval: null };
            document.getElementById('timer-title').innerText = META[id].title;
            document.getElementById('timer-modal').classList.add('open');
            updateTimerUI();
        }

        function toggleTimerState() {
            const btn = document.getElementById('timer-toggle-btn');
            const icon = document.getElementById('timer-icon');
            const text = document.getElementById('timer-text');
            
            if (timerObj.running) {
                clearInterval(timerObj.interval); 
                timerObj.running = false;
                icon.innerText = 'play_arrow'; text.innerText = '繼續';
                btn.className = "flex-1 bg-white/10 text-white font-bold py-4 rounded-2xl press flex items-center justify-center gap-2";
            } else {
                timerObj.running = true;
                icon.innerText = 'pause'; text.innerText = '暫停';
                btn.className = "flex-1 bg-gradient-to-r from-[#D4AF37] to-[#F2D06B] text-black font-bold py-4 rounded-2xl shadow-glow-gold press flex items-center justify-center gap-2";
                
                timerObj.interval = setInterval(() => {
                    timerObj.rem--;
                    updateTimerUI();
                    if(timerObj.rem <= 0) finishTimer();
                }, 1000);
            }
        }

        function updateTimerUI() {
            const m = Math.floor(timerObj.rem / 60);
            const s = timerObj.rem % 60;
            document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            const pct = timerObj.rem / timerObj.total;
            const offset = 880 - (880 * pct); 
            document.getElementById('timer-svg-prog').style.strokeDashoffset = offset;
        }

        function resetTimer() {
            clearInterval(timerObj.interval);
            timerObj.running = false;
            timerObj.rem = timerObj.total;
            const btn = document.getElementById('timer-toggle-btn');
            const icon = document.getElementById('timer-icon');
            const text = document.getElementById('timer-text');
            icon.innerText = 'play_arrow'; text.innerText = '開始';
            btn.className = "flex-1 bg-gradient-to-r from-[#D4AF37] to-[#F2D06B] text-black font-bold py-4 rounded-2xl shadow-glow-gold press flex items-center justify-center gap-2";
            updateTimerUI();
        }

        function finishTimer() {
            clearInterval(timerObj.interval);
            closeModal('timer-modal');
            const L = db.logs[activeDate];
            if(!L.tasks[timerObj.id]) {
                actionWrapper(() => { L.tasks[timerObj.id] = true; }, { currentTarget: document.body }, true);
                confettiBurst();
            }
        }

        // --- CALENDAR MODAL ---
        let viewingDate = null;

        function openDayDetail(dateStr) {
            viewingDate = dateStr;
            const d = db.logs[dateStr] || { water: 0, bowel: false, tasks: {}, notes: {} };
            document.getElementById('day-modal').classList.add('open');
            
            const [y, m, day] = dateStr.split('-');
            document.getElementById('day-modal-title').innerText = `${m}月${day}日`;
            
            const t = d.tasks || {};
            const n = d.notes || {};

            const row = (label, isDone) => `
                <div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                    <span class="text-sm text-gray-400">${label}</span>
                    <span class="material-icons-round text-sm ${isDone ? 'text-primary' : 'text-gray-700'}">${isDone ? 'check_circle' : 'remove'}</span>
                </div>
            `;
            
            const quote = (text, placeholder) => `
                <div class="relative bg-white/5 rounded-xl p-4 mt-2">
                    <span class="material-icons-round text-primary/20 absolute top-2 left-2 text-3xl">format_quote</span>
                    <p class="text-sm text-gray-200 leading-relaxed relative z-10 pl-6 italic">${escape(text) || `<span class="text-gray-600 not-italic">${placeholder}</span>`}</p>
                </div>
            `;

            const content = `
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Hydration</div>
                        <div class="text-2xl font-display text-white">${d.water || 0}<span class="text-xs ml-1 text-gray-400">ml</span></div>
                    </div>
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5">
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Bowel</div>
                        <div class="text-2xl font-bold ${d.bowel?'text-accent-blue':'text-gray-600'}">${d.bowel?'Healthy':'—'}</div>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xs font-bold text-primary tracking-widest uppercase mb-2">Training & Focus</h4>
                    <div class="bg-white/5 rounded-2xl px-4 py-1 border border-white/5">
                        ${row('大師深蹲', t.squat)}
                        ${row('阻力訓練', t.resist)}
                        ${row('DIAAS 早餐', t.breakfast)}
                        ${row('深度閱讀', t.read)}
                        ${row('靜默靈修', t.devotion)}
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xs font-bold text-primary tracking-widest uppercase mb-2">Mental Logs</h4>
                    <div class="mb-4">
                        <span class="text-xs text-gray-400 pl-1">Brand Strategy</span>
                        ${quote(n.brand, '無策略紀錄')}
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 pl-1">Growth Reflection</span>
                        ${quote(n.growth, '無成長紀錄')}
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-primary tracking-widest uppercase mb-2">Spirit & Journal</h4>
                    <div class="mb-4">
                        <span class="text-xs text-gold pl-1">${escape(n.scripture) || 'Scripture'}</span>
                        ${quote(n.spirit, '無靈修心得')}
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 pl-1">Daily Journal</span>
                        ${quote(n.journal, '無每日總結')}
                    </div>
                </div>
            `;
            document.getElementById('day-modal-content').innerHTML = content;
        }

        function changeMonth(offset) {
            const d = new Date(activeDate);
            d.setMonth(d.getMonth() + offset);
            activeDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            renderView();
        }

        function setActiveDayFromModal() {
            activeDate = viewingDate;
            closeModal('day-modal');
            router('body'); 
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
            if(id === 'timer-modal') clearInterval(timerObj.interval);
        }

        function escape(s){ return String(s || "").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

        // --- EFFECTS ---
        function showFloatingXP(amount, x, y, combo) {
            const el = document.createElement('div');
            el.className = `xp-float ${amount > 0 ? 'xp-plus' : 'xp-minus'}`;
            let text = amount > 0 ? `+${amount} XP` : `${amount} XP`;
            if (amount > 0 && combo > 1) text += ` (Combo x${combo})`;
            el.innerText = text;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function confettiBurst() {
            const c = document.getElementById("confetti");
            const ctx = c.getContext("2d");
            c.width = window.innerWidth; c.height = window.innerHeight;
            let particles = [];
            for(let i=0; i<50; i++) {
                particles.push({
                    x: c.width/2, y: c.height/2,
                    vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15 - 5,
                    color: `hsl(${Math.random()*40 + 30}, 100%, 60%)`, 
                    life: 80 + Math.random()*40
                });
            }
            function draw() {
                ctx.clearRect(0,0,c.width,c.height);
                particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                    if(p.life <= 0) particles.splice(i, 1);
                });
                if(particles.length > 0) requestAnimationFrame(draw);
            }
            draw();
        }

        // Init App
        initDB();
        initDate(activeDate);
        router('hub');

    </script>
</body>
</html>
