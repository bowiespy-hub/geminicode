<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>ATE｜Aether Trinity Evolution</title>

  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <style>
    :root {
      /* Smart Spatial Theme */
      --bg: #090a0f;
      --panel: rgba(30, 33, 45, 0.55);
      --panel-hover: rgba(40, 45, 60, 0.7);
      --card-solid: rgba(255, 255, 255, 0.03);
      --line: rgba(255, 255, 255, 0.08);
      --line-bright: rgba(255, 255, 255, 0.15);
      
      --text: #f8fafc;
      --text-muted: #94a3b8;

      /* Brand Colors */
      --primary: #f97316;     
      --primary-glow: #fb923c;
      --accent: #2dd4bf;      
      --gold: #fbbf24;
      --danger: #ef4444;
      --success: #10b981;

      --shadow-glass: 0 24px 40px -12px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 8px 30px rgba(249, 115, 22, 0.3);
      
      --radius-sm: 18px;
      --radius-md: 28px;
      --radius-lg: 36px;
      --maxw: 430px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); overflow: hidden; }
    body { font-family: "Manrope", "Noto Sans TC", sans-serif; color: var(--text); }

    /* --- Animated Ambient Background --- */
    .bg-fx { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .orb-1 {
      position: absolute; top: -10%; left: 60%; width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(249, 115, 22, 0.12) 0%, transparent 60%);
      border-radius: 50%; filter: blur(60px);
      animation: floatOrb 15s ease-in-out infinite alternate;
    }
    .orb-2 {
      position: absolute; bottom: -20%; left: -10%; width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(45, 212, 191, 0.08) 0%, transparent 60%);
      border-radius: 50%; filter: blur(60px);
      animation: floatOrb 20s ease-in-out infinite alternate-reverse;
    }
    @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(-20px, 20px) scale(1.05); } }

    .grain {
      position: fixed; inset: 0; pointer-events: none; z-index: 1; opacity: 0.04;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    .app-container { position: relative; max-width: var(--maxw); margin: 0 auto; height: 100%; display: flex; flex-direction: column; z-index: 10; }
    .scroll-area { flex: 1; overflow-y: auto; padding: 24px 20px 140px 20px; scrollbar-width: none; }
    .scroll-area::-webkit-scrollbar { display: none; }

    /* --- Subtle Animations (No Bounce) --- */
    .stagger-1 { animation: slideUpFade 0.4s ease-out 0.05s both; opacity: 0; }
    .stagger-2 { animation: slideUpFade 0.4s ease-out 0.10s both; opacity: 0; }
    .stagger-3 { animation: slideUpFade 0.4s ease-out 0.15s both; opacity: 0; }
    .stagger-4 { animation: slideUpFade 0.4s ease-out 0.20s both; opacity: 0; }
    
    @keyframes slideUpFade {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Glass & Bento Cards --- */
    .bento-card {
      background: var(--panel); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      border: 1px solid var(--line); border-radius: var(--radius-md);
      padding: 24px; display: flex; flex-direction: column; justify-content: space-between;
      box-shadow: var(--shadow-glass); position: relative; overflow: hidden;
      transition: all 0.2s ease-out;
    }
    .bento-card::before {
      content: ''; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
      background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    .press-card:active { transform: scale(0.98); background: var(--panel-hover); }
    .grid-bento { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .col-span-2 { grid-column: span 2; }

    /* --- Typography & Tags --- */
    h1, h2, h3, h4 { margin: 0; font-weight: 800; letter-spacing: 0.3px; }
    h2 { font-size: 26px; margin-bottom: 4px; line-height: 1.2; }
    .greeting { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; line-height: 1.2;}
    .date-sub { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .val-huge { font-size: 40px; font-weight: 300; font-feature-settings: "tnum"; letter-spacing: -1px; }

    .c-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }
    .c-val { font-size: 28px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
    .c-sub { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
    
    .pill-tag {
      display: inline-flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 12px; border-radius: 99px;
      font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
      background: rgba(255,255,255,0.06); border: 1px solid var(--line); line-height: 1;
    }
    .pill-tag.amber { background: rgba(249, 115, 22, 0.15); color: var(--primary-glow); border-color: rgba(249, 115, 22, 0.3); }
    .pill-tag.cyan { background: rgba(45, 212, 191, 0.15); color: var(--accent); border-color: rgba(45, 212, 191, 0.3); }

    /* Editable Name */
    .editable-name {
      display: inline-block; border-bottom: 1px dashed transparent; transition: 0.2s;
      outline: none; min-width: 50px;
    }
    .editable-name:focus { border-bottom: 1px dashed var(--primary-glow); color: var(--primary-glow); }

    /* --- Progress Rings & Bars --- */
    .prog-bar-bg { height: 6px; background: rgba(0,0,0,0.4); border-radius: 99px; overflow: hidden; margin-top: 12px; }
    .prog-bar-fill { height: 100%; background: linear-gradient(90deg, #f97316, #f59e0b); border-radius: 99px; transition: width 0.6s ease-out; box-shadow: var(--shadow-glow); }
    .prog-bar-cyan { background: linear-gradient(90deg, #0ea5e9, #2dd4bf); box-shadow: 0 0 15px rgba(45,212,191,0.4); }

    /* --- Top Header --- */
    .top-bar { display: flex; justify-content: space-between; align-items: center; }
    .top-avatar { 
      width: 48px; height: 48px; border-radius: 16px; overflow: hidden; 
      border: 1px solid var(--line-bright); cursor: pointer; transition: transform 0.2s ease-out;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
    }
    .top-avatar:active { transform: scale(0.95); }
    .top-avatar img { width: 100%; height: 100%; object-fit: cover; }

    /* --- Task Widgets --- */
    .widget {
      background: var(--card-solid); border: 1px solid var(--line);
      border-radius: var(--radius-md); padding: 18px;
      display: flex; flex-direction: column; justify-content: space-between;
      min-height: 140px; position: relative; transition: 0.2s ease-out;
    }
    .widget.active { background: rgba(249, 115, 22, 0.08); border-color: rgba(249, 115, 22, 0.3); }
    .w-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .w-icon { 
      width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.05); 
      display: flex; align-items: center; justify-content: center; color: var(--text-muted);
      transition: 0.2s; line-height: 1;
    }
    .widget.active .w-icon { background: var(--primary); color: #fff; box-shadow: var(--shadow-glow); }
    .w-title { font-size: 15px; font-weight: 700; margin-top: auto; padding-top: 16px; }
    .w-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; font-variant-numeric: tabular-nums; }
    
    .w-actions { display: flex; gap: 8px; align-items: center; }
    .w-btn {
      width: 36px; height: 36px; border-radius: 12px; border: 1px solid var(--line-bright);
      background: rgba(255,255,255,0.05); color: #fff; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s ease-out; backdrop-filter: blur(10px); line-height: 1;
    }
    .w-btn:active { transform: scale(0.95); }
    .widget.active .w-btn { border-color: transparent; background: transparent; color: var(--primary); }

    /* --- Inputs --- */
    .input-glass {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--line);
      color: white; padding: 18px; border-radius: var(--radius-sm); font-family: inherit; font-size: 14px;
      outline: none; transition: border-color 0.2s, background 0.2s; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
    }
    .input-glass:focus { border-color: var(--primary-glow); background: rgba(249, 115, 22, 0.05); }
    textarea.input-glass { resize: none; min-height: 110px; line-height: 1.6; }

    /* --- Buttons --- */
    .btn-solid {
      width: 100%; border: none; background: var(--line-bright); color: white;
      padding: 14px 16px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 700;
      cursor: pointer; transition: 0.2s ease-out; display: flex; align-items: center; justify-content: center; gap: 6px;
      line-height: 1;
    }
    .btn-solid.accent { background: var(--primary); box-shadow: var(--shadow-glow); }
    .btn-solid:active { transform: scale(0.98); }
    
    .btn-icon {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: 0.2s ease-out; line-height: 1;
    }
    .btn-icon:active { transform: scale(0.98); }

    /* --- Switch --- */
    .switch {
      width: 52px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 99px;
      position: relative; transition: 0.2s ease-out; cursor: pointer; border: 1px solid var(--line);
    }
    .switch::after {
      content: ''; position: absolute; left: 4px; top: 4px; width: 22px; height: 22px;
      background: var(--text-muted); border-radius: 50%; transition: 0.2s ease-out;
    }
    .switch.on { background: var(--primary); border-color: var(--primary-glow); box-shadow: var(--shadow-glow); }
    .switch.on::after { transform: translateX(20px); background: #fff; }

    /* --- Bottom Nav --- */
    .nav-wrap {
      position: absolute; bottom: 32px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 48px); max-width: 360px; z-index: 100;
    }
    .nav-pill {
      background: rgba(15, 18, 25, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      border-radius: 99px; border: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 16px; box-shadow: 0 24px 50px rgba(0,0,0,0.8);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 56px; height: 56px; border-radius: 50%;
      color: var(--text-muted); font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s ease-out;
      line-height: 1;
    }
    .nav-item.active { color: var(--primary-glow); transform: translateY(-2px); }
    .nav-item .material-symbols-outlined { font-size: 24px; margin-bottom: 4px; transition: 0.2s ease-out; display: block; }
    .nav-item.active .material-symbols-outlined { font-variation-settings: 'FILL' 1; filter: drop-shadow(0 0 10px var(--primary)); }
    .nav-item:active { transform: scale(0.95); }

    /* --- Modals --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); z-index: 200; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out; }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-sheet { background: var(--bg); width: 100%; max-width: var(--maxw); border-radius: 40px 40px 0 0; padding: 32px 24px 40px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.4s ease-out; border-top: 1px solid var(--line); box-shadow: 0 -20px 50px rgba(0,0,0,0.6); }
    .modal-overlay.open .modal-sheet { transform: translateY(0); }
    .modal-sheet::-webkit-scrollbar { display:none; }

    /* --- Modal Detail Grid --- */
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;}
    .d-card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); border-radius: var(--radius-sm); padding: 16px; }
    .d-card-full { grid-column: span 2; background: rgba(255,255,255,0.03); border: 1px solid var(--line); border-radius: var(--radius-sm); padding: 16px; }
    .d-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .d-row:last-child { border-bottom: none; }
    .d-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
    .d-icon.ok { background: rgba(45,212,191,0.2); color: var(--accent); }
    .d-icon.no { background: rgba(255,255,255,0.1); color: var(--muted); }
    .d-text { font-size: 14px; line-height: 1.6; color: #fff; margin-top: 8px; font-style: italic; opacity: 0.9;}

    /* --- Calendar Grid --- */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 16px; }
    .cal-day {
      aspect-ratio: 1; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      background: var(--card-solid); font-weight: 700; font-size: 14px; color: var(--text-muted);
      position: relative; border: 1px solid var(--line); cursor: pointer; transition: 0.2s ease-out;
    }
    .cal-day:active { transform: scale(0.95); }
    .cal-day.perfect { background: linear-gradient(135deg, var(--primary), #ea580c); color: white; box-shadow: var(--shadow-glow); border: none; }
    .cal-day.today { border-color: var(--accent); color: white; }
    .cal-day.selected { outline: 2px solid white; outline-offset: 2px; background: rgba(255,255,255,0.1); color: white; }

    /* --- XP FX --- */
    .xp-float { position: fixed; z-index: 999; pointer-events: none; font-weight: 800; font-size: 18px; letter-spacing: 0.5px; text-shadow: 0 4px 10px rgba(0,0,0,0.8); transform: translate(-50%, -50%); opacity: 0; animation: floatUp 0.8s ease-out forwards; }
    .xp-plus { color: var(--primary-glow); }
    .xp-minus { color: var(--danger); }
    @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 0) scale(0.9); } 15% { opacity: 1; transform: translate(-50%, -15px) scale(1.05); } 100% { opacity: 0; transform: translate(-50%, -40px) scale(1); } }

    .view-section { display: none; opacity: 0; }
    .view-section.active { display: flex; opacity: 1; }

    /* Toast */
    .toast{ position:fixed; top:24px; left:50%; transform:translateX(-50%) translateY(-10px); z-index:90; padding:12px 20px; border-radius:99px; border:1px solid var(--line-bright); background:rgba(30,33,45,.95); backdrop-filter: blur(20px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size:13px; font-weight:800; letter-spacing:1px; text-transform:uppercase; opacity:0; pointer-events:none; transition: all 0.3s ease-out; color: white; }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  </style>
</head>
<body>

  <div class="bg-fx">
    <div class="orb-1"></div>
    <div class="orb-2"></div>
  </div>
  <div class="grain"></div>
  <canvas id="confetti" style="position:fixed; inset:0; pointer-events:none; z-index:300;"></canvas>
  <div class="toast" id="toast">Saved</div>

  <div class="app-container">
    
    <div id="main-view" class="scroll-area"></div>

    <div class="nav-wrap">
      <div class="nav-pill">
        <div class="nav-item active" onclick="router('hub')" id="nav-hub">
          <span class="material-symbols-outlined">dashboard</span><span>Hub</span>
        </div>
        <div class="nav-item" onclick="router('body')" id="nav-body">
          <span class="material-symbols-outlined">vital_signs</span><span>Body</span>
        </div>
        <div class="nav-item" onclick="router('mind')" id="nav-mind">
          <span class="material-symbols-outlined">psychology</span><span>Mind</span>
        </div>
        <div class="nav-item" onclick="router('cal')" id="nav-cal">
          <span class="material-symbols-outlined">calendar_month</span><span>History</span>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL: TIMER -->
  <div class="modal-overlay" id="timer-modal">
    <div class="modal-sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div class="pill-tag amber"><span class="material-symbols-outlined" style="font-size:14px; line-height:1;">timer</span> Focus Session</div>
        <button class="btn-icon press" style="width:36px; height:36px;" onclick="closeModal('timer-modal')">
          <span class="material-symbols-outlined" style="font-size:20px; line-height:1;">close</span>
        </button>
      </div>
      <h2 id="timer-title" style="text-align:center; font-size:28px;">Task</h2>
      <div class="val-huge" style="font-size:72px; text-align:center; margin:30px 0; color:var(--text);" id="timer-display">00:00</div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <button class="btn-solid accent" id="timer-toggle-btn" onclick="toggleTimerState()">Start</button>
        <button class="btn-solid" onclick="resetTimer()">Reset</button>
      </div>
    </div>
  </div>

  <!-- MODAL: DAY DETAIL -->
  <div class="modal-overlay" id="day-modal">
    <div class="modal-sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div class="pill-tag cyan"><span class="material-symbols-outlined" style="font-size:14px; line-height:1;">history</span> Timeline History</div>
        <button class="btn-icon press" style="width:36px; height:36px;" onclick="closeModal('day-modal')">
          <span class="material-symbols-outlined" style="font-size:20px; line-height:1;">close</span>
        </button>
      </div>
      <h2 id="day-modal-title" style="margin-bottom:24px; font-size:32px;">Date</h2>
      <div id="day-modal-content"></div>
      <button class="btn-solid" style="margin-top:32px; background:rgba(249, 115, 22, 0.1); color:var(--primary-glow); border:1px solid var(--primary-glow)" onclick="setActiveDayFromModal()">Edit This Day (補登此日)</button>
    </div>
  </div>

  <script>
    /* =========================================
       ATE V15 - ULTIMATE ZERO-FLICKER ENGINE
    ========================================= */
    const DB_KEY = 'ATE_PRO_V15'; 
    const WATER_TARGET = 1900;
    
    const META = {
      squat: { title: "Squats", xp: 60, icon: "fitness_center", type: "timer", dur: 15*60 },
      resist: { title: "Resistance", xp: 80, icon: "exercise", type: "timer", dur: 30*60 },
      read: { title: "Deep Reading", xp: 70, icon: "menu_book", type: "timer", dur: 20*60 },
      breakfast: { title: "DIAAS Yogurt", xp: 30, icon: "restaurant", type: "check" },
      devotion: { title: "Devotion", xp: 60, icon: "spa", type: "timer", dur: 10*60 },
      bowel: { xp: 20 },
      notes: { growth: 40, brand: 40, scripture: 30, spirit: 50, journal: 30 },
      waterGoal: 100 
    };

    let db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
    let activeDate = getTodayStr(); 
    let timerObj = { id: null, rem: 0, total: 0, interval: null, running: false };
    let isNavigating = false; // Flag to control enter animations

    // --- DB UTILS ---
    function getTodayStr() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function initDB() {
      if (!db.settings) db.settings = { userName: "覺醒女神" };
      if (!db.gamify) db.gamify = { combo: 1, lastActive: 0 };
      if (!db.logs) db.logs = {};
    }

    function initDate(dateStr) {
      if (!db.logs[dateStr]) {
        db.logs[dateStr] = {
          water: 0, bowel: false,
          tasks: { squat: false, resist: false, read: false, breakfast: false, devotion: false },
          notes: { growth: "", brand: "", scripture: "", spirit: "", journal: "" }
        };
        saveDB();
      }
    }

    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function resetAll() {
      if(confirm("【系統重置】確定要清除所有紀錄並從 0 開始嗎？")) {
        localStorage.removeItem(DB_KEY); location.reload();
      }
    }

    function isPerfect(dateStr) {
      const d = db.logs[dateStr];
      if(!d || !d.tasks) return false;
      return (d.water >= WATER_TARGET) && d.tasks.squat && d.tasks.resist && d.tasks.breakfast;
    }

    // --- GAMIFICATION ENGINE ---
    function calcStreak() {
      let streak = 0;
      const today = new Date();
      for (let i=0; i<365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
        
        const d = db.logs[dateStr];
        let isActive = false;
        if (d) {
           const tasksDone = Object.values(d.tasks).some(v => v);
           const notesWritten = Object.values(d.notes).some(v => v.trim() !== "");
           isActive = (d.water > 0) || tasksDone || notesWritten || d.bowel;
        }
        
        if (isActive) streak++;
        else if (i > 0) break;
      }
      return streak;
    }

    function calcTotalXP() {
      let total = 0;
      Object.keys(db.logs).forEach(date => {
        const d = db.logs[date];
        if(!d || !d.tasks) return; 
        
        if(d.tasks.squat) total += META.squat.xp;
        if(d.tasks.resist) total += META.resist.xp;
        if(d.tasks.read) total += META.read.xp;
        if(d.tasks.breakfast) total += META.breakfast.xp;
        if(d.tasks.devotion) total += META.devotion.xp;
        if(d.bowel) total += META.bowel.xp;
        
        if(d.notes.growth?.trim()) total += META.notes.growth;
        if(d.notes.brand?.trim()) total += META.notes.brand;
        if(d.notes.scripture?.trim()) total += META.notes.scripture;
        if(d.notes.spirit?.trim()) total += META.notes.spirit;
        if(d.notes.journal?.trim()) total += META.notes.journal;
        
        if(d.water >= WATER_TARGET) total += META.waterGoal;
        total += Math.floor(d.water / 500) * 10; 
      });
      return total;
    }

    function updateName(newName) {
      if(newName.trim() !== "") {
        db.settings.userName = newName.trim();
        saveDB();
        toast("Profile Updated");
      }
    }

    // --- ACTIONS (STATELESS) ---
    function actionWrapper(fn, event, isPositiveAction) {
      const oldXP = calcTotalXP();
      const now = Date.now();
      
      if (isPositiveAction) {
        if (now - db.gamify.lastActive <= 5 * 60 * 1000) db.gamify.combo = Math.min(db.gamify.combo + 1, 5); 
        else db.gamify.combo = 1;
        db.gamify.lastActive = now;
      }

      fn();
      saveDB();
      
      const newXP = calcTotalXP();
      const diff = newXP - oldXP;
      
      if(diff !== 0 && event && event.currentTarget) {
        const rect = event.currentTarget.getBoundingClientRect();
        showFloatingXP(diff, rect.left + rect.width / 2, rect.top, db.gamify.combo);
      }
      
      refreshUI(); // Use targeted refresh instead of full render
    }

    function modWater(amount, event) {
      if (db.logs[activeDate].water + amount < 0) return;
      actionWrapper(() => { db.logs[activeDate].water += amount; }, event, amount > 0);
    }

    function toggleBowel(event) {
      const willBeTrue = !db.logs[activeDate].bowel;
      actionWrapper(() => { db.logs[activeDate].bowel = willBeTrue; }, event, willBeTrue);
    }

    function toggleTask(id, event) {
      const willBeTrue = !db.logs[activeDate].tasks[id];
      actionWrapper(() => { db.logs[activeDate].tasks[id] = willBeTrue; }, event, willBeTrue);
      if(willBeTrue && isPerfect(activeDate)) confettiBurst();
    }

    function saveNote(type, val) {
      const wasEmpty = db.logs[activeDate].notes[type].trim() === "";
      const isEmpty = val.trim() === "";
      actionWrapper(() => { db.logs[activeDate].notes[type] = val; }, null, !isEmpty);
      
      if (wasEmpty && !isEmpty) toast("Note Saved +XP");
      else if (!wasEmpty && isEmpty) toast("Note Cleared");
      else toast("Saved");
    }

    // --- TARGETED UI REFRESH (ZERO FLICKER) ---
    function updateEl(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
    function updateStyle(id, prop, val) { const el = document.getElementById(id); if(el) el.style[prop] = val; }

    function refreshUI() {
      const data = db.logs[activeDate];
      const xp = calcTotalXP();
      const level = Math.floor(xp / 500) + 1;
      const xpPct = ((xp % 500) / 500) * 100;
      const currentStreak = calcStreak();
      const perfCount = Object.keys(db.logs).filter(k => isPerfect(k)).length;

      // Update Hub
      updateEl('hub-level', level);
      updateEl('hub-xp-text', `${xp} / ${level*500} XP`);
      updateStyle('hub-xp-bar', 'width', `${xpPct}%`);
      updateEl('hub-streak', currentStreak);
      updateEl('hub-perf-count', perfCount);
      
      const bTasks = (data.tasks.squat?1:0) + (data.tasks.resist?1:0) + (data.tasks.breakfast?1:0);
      const wScore = Math.min(data.water/WATER_TARGET, 1) * 100;
      const bScore = Math.round((wScore * 0.4) + ((bTasks/3)*100 * 0.6));
      updateEl('hub-body-score', `${bScore}%`);
      updateStyle('hub-body-bar', 'width', `${bScore}%`);

      // Update Body
      updateEl('water-val', data.water);
      updateStyle('water-progress', 'width', `${wScore}%`);
      const bowelToggle = document.getElementById('bowel-toggle');
      if(bowelToggle) bowelToggle.className = `switch ${data.bowel ? 'on' : ''}`;

      // Update Task Widgets Dynamically
      ['squat', 'resist', 'breakfast', 'read', 'devotion'].forEach(id => {
         const tWrap = document.getElementById(`task-wrap-${id}`);
         if (tWrap) {
             tWrap.className = `widget ${data.tasks[id] ? 'active' : ''}`;
             tWrap.innerHTML = buildWidgetInner(id);
         }
      });

      // Update Calendar (Safe to re-render grid as it has no inputs)
      if (currentView === 'cal') renderCalendarGrid();
    }

    function stag(n) { return isNavigating ? `stagger-${n}` : ''; }

    // --- ROUTER & RENDER ---
    function router(view) {
      currentView = view;
      isNavigating = true;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById(`nav-${view}`).classList.add('active');
      renderView();
      isNavigating = false;
    }

    function renderView() {
      const main = document.getElementById('main-view');
      initDB();
      initDate(activeDate);
      const data = db.logs[activeDate];
      const xp = calcTotalXP();
      const level = Math.floor(xp / 500) + 1;
      const nextXP = level * 500;
      const xpPct = ((xp % 500) / 500) * 100;
      const currentStreak = calcStreak();
      const perfCount = Object.keys(db.logs).filter(k => isPerfect(k)).length;

      let html = '';

      if (currentView === 'hub') {
        const bTasks = (data.tasks.squat?1:0) + (data.tasks.resist?1:0) + (data.tasks.breakfast?1:0);
        const wScore = Math.min(data.water/WATER_TARGET, 1) * 100;
        const bScore = Math.round((wScore * 0.4) + ((bTasks/3)*100 * 0.6));

        html = `
          <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="top-bar ${stag(1)}">
              <div>
                <h1 class="greeting">Welcome, <br><span class="editable-name" contenteditable="true" onblur="updateName(this.innerText)" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${db.settings.userName}</span></h1>
                <div class="date-sub">${new Date().toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
              </div>
              <div class="top-avatar" onclick="resetAll()" title="Reset DB">
                <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuCAYOzNGEzdDG66QmmNGCUlkdnwk7zJo0-6al0p4StVVrRy7UvwIFfnSbzk1yro93SGmClDJXzHkeK0f3pOKlJ7_0wH9VzNbQ3ATQRP2P4Msi2j3L88v-cPqgWfProkys6HXeVgnOq9poVFtfNyxvn9pqj2xho4IOb0kutPRkMrNn2qgl6IG3CfgZJFN6h_2N_KyQQzgP3uX0T6tGAkUnEDgaVjHUIXMZVxocw3H1i2okCF0BovjWGbicSrh5A42xuvBTiOpnUCuI0">
              </div>
            </div>

            <div class="bento-card col-span-2 press-card ${stag(2)}" onclick="router('body')" style="background: linear-gradient(145deg, rgba(249, 115, 22, 0.12) 0%, rgba(30, 33, 45, 0.6) 100%);">
              <span class="c-label" style="color:var(--primary-glow)">System Energy</span>
              <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="c-val" id="hub-body-score">${bScore}%</div><div class="c-sub">Today's Body Metrics</div></div>
                <span class="material-symbols-outlined" style="color:var(--primary); font-size:36px; font-variation-settings: 'FILL' 1; line-height:1;">bolt</span>
              </div>
              <div class="prog-bar-bg"><div class="prog-bar-fill" id="hub-body-bar" style="width: ${bScore}%"></div></div>
            </div>

            <div class="grid-bento ${stag(3)}">
              <div class="bento-card">
                <span class="c-label">Level</span>
                <div class="c-val" style="font-size:36px; margin-bottom:0;" id="hub-level">${level}</div>
                <div class="c-sub" style="margin-top:8px" id="hub-xp-text">${xp} / ${nextXP} XP</div>
                <div class="prog-bar-bg" style="height:4px; margin-top:8px;"><div class="prog-bar-fill prog-bar-cyan" id="hub-xp-bar" style="width: ${xpPct}%"></div></div>
              </div>
              <div class="bento-card press-card" onclick="router('cal')">
                <span class="c-label">Streak</span>
                <div style="display:flex; align-items:center; gap:8px;">
                  <span class="material-symbols-outlined" style="color:var(--gold); font-size:32px; font-variation-settings: 'FILL' 1; line-height:1;">local_fire_department</span>
                  <div class="c-val" style="font-size:36px; margin-bottom:0;" id="hub-streak">${currentStreak}</div>
                </div>
                <div class="c-sub" style="margin-top:8px"><span id="hub-perf-count">${perfCount}</span> Perfect Days</div>
              </div>
            </div>

            <div class="bento-card col-span-2 press-card ${stag(4)}" onclick="router('mind')" style="flex-direction:row; align-items:center;">
              <div><div class="c-val" style="font-size:18px">Mind & Spirit</div><div class="c-sub">Log today's strategy & thoughts</div></div>
              <div class="w-btn" style="background:var(--card-solid)"><span class="material-symbols-outlined" style="line-height:1;">arrow_forward</span></div>
            </div>

            <div class="bento-card col-span-2 ${stag(4)}" style="border-color: rgba(45, 212, 191, 0.2);">
              <span class="c-label" style="color:var(--accent)">DAILY JOURNAL</span>
              <div class="c-sub" style="margin-bottom:12px;">寫下今天的一句話，總結你的進化。</div>
              <textarea class="input-glass" style="min-height:80px;" placeholder="Today I am grateful for..." onblur="saveNote('journal', this.value)">${data.notes.journal || ''}</textarea>
            </div>
          </div>
        `;
      } 
      
      else if (currentView === 'body') {
        const wPct = Math.min(data.water / WATER_TARGET * 100, 100);
        html = `
          <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="top-bar ${stag(1)}">
              <div><h1 class="greeting">Body</h1><div class="date-sub">${activeDate === getTodayStr() ? 'TODAY' : activeDate}</div></div>
            </div>

            <div class="bento-card col-span-2 ${stag(2)}">
              <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div><span class="c-label">Hydration</span><div class="val-huge" id="water-val">${data.water}</div></div>
                <span class="pill-tag cyan"><span class="material-symbols-outlined" style="font-size:14px; line-height:1;">flag</span> ${WATER_TARGET} ML</span>
              </div>
              <div class="prog-bar-bg" style="height:12px; margin: 16px 0;"><div class="prog-bar-fill prog-bar-cyan" id="water-progress" style="width: ${wPct}%"></div></div>
              <div style="display:flex; gap:12px;">
                <button class="btn-solid" style="flex:1" onclick="modWater(250, event)">+ 250</button>
                <button class="btn-solid accent" style="flex:1" onclick="modWater(500, event)">+ 500</button>
                <button class="btn-solid" style="width:52px; padding:0; background:rgba(239, 68, 68, 0.15); color:var(--danger);" onclick="modWater(-250, event)"><span class="material-symbols-outlined" style="line-height:1;">remove</span></button>
              </div>
            </div>

            <div class="${stag(3)}">
              <h3 style="margin-bottom:12px;">Training</h3>
              <div class="grid-bento">
                <div class="widget ${data.tasks.squat ? 'active' : ''}" id="task-wrap-squat">${buildWidgetInner('squat')}</div>
                <div class="widget ${data.tasks.resist ? 'active' : ''}" id="task-wrap-resist">${buildWidgetInner('resist')}</div>
              </div>
              <div class="grid-bento" style="margin-top:16px;">
                <div class="widget ${data.tasks.breakfast ? 'active' : ''}" id="task-wrap-breakfast">${buildWidgetInner('breakfast')}</div>
                <div class="widget ${data.bowel ? 'active' : ''}">
                  <div class="w-top">
                    <div class="w-icon"><span class="material-symbols-outlined" style="line-height:1;">gastroenterology</span></div>
                    <div class="switch ${data.bowel ? 'on' : ''}" id="bowel-toggle" onclick="toggleBowel(event)"></div>
                  </div>
                  <div><div class="w-title">Bowel Check</div><div class="w-meta">Daily Health</div></div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      else if (currentView === 'mind') {
        html = `
          <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="top-bar ${stag(1)}">
              <div><h1 class="greeting">Mind & Spirit</h1><div class="date-sub">${activeDate === getTodayStr() ? 'TODAY' : activeDate}</div></div>
            </div>

            <div class="grid-bento ${stag(2)}">
              <div class="widget ${data.tasks.read ? 'active' : ''}" id="task-wrap-read">${buildWidgetInner('read')}</div>
              <div class="widget ${data.tasks.devotion ? 'active' : ''}" id="task-wrap-devotion">${buildWidgetInner('devotion')}</div>
            </div>

            <div class="${stag(3)}">
              <h3 style="margin-bottom:12px;">Strategy Logs</h3>
              <div class="bento-card col-span-2" style="padding:20px;">
                <span class="c-label" style="color:var(--primary-glow)">Brand Strategy</span>
                <textarea class="input-glass" placeholder="關於個人品牌的策略與靈感..." onblur="saveNote('brand', this.value)">${data.notes.brand}</textarea>
              </div>
            </div>

            <div class="bento-card col-span-2 ${stag(3)}" style="padding:20px;">
              <span class="c-label" style="color:var(--primary-glow)">Growth Reflection</span>
              <input type="text" class="input-glass" placeholder="今天學到了什麼？" value="${data.notes.growth}" onblur="saveNote('growth', this.value)">
            </div>

            <div class="${stag(4)}">
              <h3 style="margin-bottom:12px; color:var(--gold)">Spirit</h3>
              <div class="bento-card col-span-2" style="padding:20px; border-color:rgba(245, 158, 11, 0.2);">
                <span class="c-label" style="color:var(--gold)">Daily Scripture</span>
                <input type="text" class="input-glass" placeholder="Verse (e.g. Psalm 23:1)" value="${data.notes.scripture}" onblur="saveNote('scripture', this.value)" style="margin-bottom:12px;">
                <textarea class="input-glass" placeholder="靈修心得與領受..." onblur="saveNote('spirit', this.value)">${data.notes.spirit}</textarea>
              </div>
            </div>
          </div>
        `;
      }

      else if (currentView === 'cal') {
        html = `
          <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="top-bar ${stag(1)}">
              <div><h1 class="greeting">History</h1><div class="date-sub">Evolution Log</div></div>
            </div>
            <div class="bento-card col-span-2 ${stag(2)}" id="calendar-wrapper">
              <!-- Rendered via JS -->
            </div>
          </div>
        `;
        // Delay grid render slightly to ensure wrapper exists
        setTimeout(renderCalendarGrid, 0); 
      }

      main.innerHTML = html;
      main.className = `scroll-area active`; 
    }

    // --- TARGETED COMPONENT RENDER ---
    function buildWidgetInner(id) {
      const isDone = db.logs[activeDate].tasks[id];
      const m = META[id];
      
      let actionBtn = '';
      if (m.type === 'timer') {
        actionBtn = `
          <div class="w-actions">
            ${!isDone ? `<button class="w-btn" onclick="openTimer('${id}')"><span class="material-symbols-outlined" style="font-size:18px">play_arrow</span></button>` : ''}
            <button class="w-btn" style="${isDone ? 'background:transparent; border:none; color:var(--primary);' : ''}" onclick="toggleTask('${id}', event)">
              <span class="material-symbols-outlined" style="font-size:18px">${isDone ? 'check_circle' : 'check'}</span>
            </button>
          </div>
        `;
      } else {
        actionBtn = `
          <div class="w-actions">
            <button class="w-btn" style="${isDone ? 'background:transparent; border:none; color:var(--primary);' : ''}" onclick="toggleTask('${id}', event)">
              <span class="material-symbols-outlined" style="font-size:18px">${isDone ? 'check_circle' : 'check'}</span>
            </button>
          </div>
        `;
      }

      return `
        <div class="w-top">
          <div class="w-icon"><span class="material-symbols-outlined" style="line-height:1;">${m.icon}</span></div>
          ${actionBtn}
        </div>
        <div>
          <div class="w-title">${m.title}</div>
          <div class="w-meta">${isDone ? 'Completed' : `+${m.xp} XP`}</div>
        </div>
      `;
    }

    let calViewDate = new Date();
    function renderCalendarGrid() {
      const wrap = document.getElementById('calendar-wrapper');
      if(!wrap) return;

      const year = calViewDate.getFullYear();
      const month = calViewDate.getMonth();
      const today = new Date();
      
      const monthName = ["January","February","March","April","May","June","July","August","September","October","November","December"][month];
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay();

      let gridHtml = '';
      for(let i=0; i<firstDay; i++) gridHtml += `<div></div>`;
      
      for(let i=1; i<=daysInMonth; i++) {
        const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        const dayData = db.logs[dateKey];
        const perfect = dayData ? isPerfect(dateKey) : false;
        const isToday = dateKey === getTodayStr();
        const selected = dateKey === activeDate;
        
        let className = 'cal-day press';
        if (perfect) className += ' perfect';
        else if (selected) className += ' selected';
        else if (isToday) className += ' today';
        
        const hasData = dayData && (dayData.water>0 || dayData.tasks.squat || dayData.notes.growth);
        const dot = hasData && !perfect ? `<div style="position:absolute; bottom:4px; width:4px; height:4px; background:var(--accent); border-radius:50%"></div>` : '';

        gridHtml += `<div class="${className}" onclick="openDayDetail('${dateKey}')">${i}${dot}</div>`;
      }

      wrap.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <button class="btn-icon press" style="width:32px;height:32px;" onclick="changeMonth(-1)"><span class="material-symbols-outlined" style="line-height:1;">chevron_left</span></button>
          <h2 style="margin:0; font-size:20px;">${monthName} ${year}</h2>
          <button class="btn-icon press" style="width:32px;height:32px;" onclick="changeMonth(1)"><span class="material-symbols-outlined" style="line-height:1;">chevron_right</span></button>
        </div>
        <div class="cal-grid" style="color:var(--text-muted); font-size:10px; text-align:center; font-weight:800; letter-spacing:1px;">
          <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
        </div>
        <div class="cal-grid">${gridHtml}</div>
      `;
    }

    // --- ZERO-LATENCY TIMER ---
    function openTimer(id) {
      const dur = META[id].dur;
      timerObj = { id, rem: dur, total: dur, running: false, interval: null };
      document.getElementById('timer-title').innerText = META[id].title;
      document.getElementById('timer-modal').classList.add('open');
      updateTimerUI();
    }

    function toggleTimerState() {
      const btn = document.getElementById('timer-toggle-btn');
      if (timerObj.running) {
        clearInterval(timerObj.interval); // INSTANT PAUSE
        timerObj.interval = null;
        timerObj.running = false;
        btn.innerText = 'Resume';
        btn.style.background = 'rgba(255,255,255,0.1)';
      } else {
        timerObj.running = true;
        btn.innerText = 'Pause';
        btn.style.background = 'var(--primary)';
        if (timerObj.interval) clearInterval(timerObj.interval);
        timerObj.interval = setInterval(() => {
          timerObj.rem--;
          updateTimerUI();
          if(timerObj.rem <= 0) finishTimer();
        }, 1000);
      }
    }

    function updateTimerUI() {
      const m = Math.floor(timerObj.rem / 60);
      const s = timerObj.rem % 60;
      document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function resetTimer() {
      clearInterval(timerObj.interval);
      timerObj.interval = null;
      timerObj.running = false;
      timerObj.rem = timerObj.total;
      document.getElementById('timer-toggle-btn').innerText = 'Start';
      document.getElementById('timer-toggle-btn').style.background = 'var(--primary)';
      updateTimerUI();
    }

    function finishTimer() {
      clearInterval(timerObj.interval);
      closeModal('timer-modal');
      const L = db.logs[activeDate];
      if(!L.tasks[timerObj.id]) {
        // Trigger completion via action wrapper for XP and visual updates
        actionWrapper(() => { L.tasks[timerObj.id] = true; }, { currentTarget: document.body }, true);
        confettiBurst();
      }
    }

    // --- CALENDAR MODAL (Full Alignment) ---
    let viewingDate = null;

    function openDayDetail(dateStr) {
      viewingDate = dateStr;
      const d = db.logs[dateStr] || { water: 0, bowel: false, tasks: {}, notes: {} };
      document.getElementById('day-modal').classList.add('open');
      document.getElementById('day-modal-title').innerText = dateStr;
      
      const t = d.tasks || {};
      const n = d.notes || {};

      const dIcon = (bool) => bool ? `<div class="d-icon ok"><span class="material-symbols-outlined" style="font-size:16px; line-height:1;">check</span></div>` : `<div class="d-icon no"><span class="material-symbols-outlined" style="font-size:16px; line-height:1;">remove</span></div>`;

      const content = `
        <div class="detail-grid">
          <div class="d-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="c-label" style="margin-bottom:2px">Hydration</div>
              <div style="font-size:18px; font-weight:800">${d.water || 0} <span style="font-size:12px;color:var(--muted)">ml</span></div>
            </div>
            ${d.water >= WATER_TARGET ? dIcon(true) : dIcon(false)}
          </div>
          <div class="d-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="c-label" style="margin-bottom:2px">Bowel</div>
              <div style="font-size:18px; font-weight:800; color:${d.bowel?'var(--accent)':'#fff'}">${d.bowel?'Healthy':'—'}</div>
            </div>
            ${dIcon(d.bowel)}
          </div>
        </div>

        <div class="d-card-full" style="margin-bottom:12px;">
          <div class="c-label" style="margin-bottom:12px; color:var(--primary-glow)">Training & Focus</div>
          <div class="d-row"><span class="d-label" style="margin:0;">Squats</span> ${dIcon(t.squat)}</div>
          <div class="d-row"><span class="d-label" style="margin:0;">Resistance</span> ${dIcon(t.resist)}</div>
          <div class="d-row"><span class="d-label" style="margin:0;">Breakfast</span> ${dIcon(t.breakfast)}</div>
          <div class="d-row"><span class="d-label" style="margin:0;">Deep Reading</span> ${dIcon(t.read)}</div>
          <div class="d-row"><span class="d-label" style="margin:0;">Devotion</span> ${dIcon(t.devotion)}</div>
        </div>
        
        <div class="d-card-full" style="margin-bottom:12px;">
          <div class="c-label" style="margin-bottom:12px; color:var(--accent)">Mental Logs</div>
          <div style="margin-bottom:16px;">
            <span class="d-label" style="font-size:11px; margin-bottom:4px;">BRAND STRATEGY</span>
            <div class="d-text">${escape(n.brand) || '—'}</div>
          </div>
          <div>
            <span class="d-label" style="font-size:11px; margin-bottom:4px;">GROWTH REFLECTION</span>
            <div class="d-text">${escape(n.growth) || '—'}</div>
          </div>
        </div>

        <div class="d-card-full">
          <div class="c-label" style="margin-bottom:12px; color:var(--gold)">Spirit & Journal</div>
          <div style="margin-bottom:16px;">
            <span class="d-label" style="font-size:11px; margin-bottom:4px;">SCRIPTURE</span>
            <div class="d-text" style="color:var(--gold)">${escape(n.scripture) || '—'}</div>
          </div>
          <div style="margin-bottom:16px;">
            <span class="d-label" style="font-size:11px; margin-bottom:4px;">REFLECTION</span>
            <div class="d-text">${escape(n.spirit) || '—'}</div>
          </div>
          <div>
            <span class="d-label" style="font-size:11px; margin-bottom:4px;">DAILY JOURNAL</span>
            <div class="d-text">${escape(n.journal) || '—'}</div>
          </div>
        </div>
      `;
      document.getElementById('day-modal-content').innerHTML = content;
    }

    function changeMonth(offset) {
      calViewDate.setMonth(calViewDate.getMonth() + offset);
      renderCalendarGrid();
    }

    function setActiveDayFromModal() {
      activeDate = viewingDate;
      closeModal('day-modal');
      router('body'); 
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('open');
      if(id === 'timer-modal') clearInterval(timerObj.interval);
    }

    function escape(s){ return String(s || "").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // --- EFFECTS ---
    function showFloatingXP(amount, x, y, combo) {
      const el = document.createElement('div');
      el.className = `xp-float ${amount > 0 ? 'xp-plus' : 'xp-minus'}`;
      let text = amount > 0 ? `+${amount} XP` : `${amount} XP`;
      if (amount > 0 && combo > 1) text += ` (x${combo})`;
      el.innerText = text;
      el.style.left = `${x}px`; el.style.top = `${y}px`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 800);
    }

    function confettiBurst() {
      const c = document.getElementById("confetti");
      const ctx = c.getContext("2d");
      c.width = window.innerWidth; c.height = window.innerHeight;
      let particles = [];
      for(let i=0; i<40; i++) {
        particles.push({
          x: c.width/2, y: c.height/2,
          vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12 - 5,
          color: `hsl(${Math.random()*60 + 15}, 100%, 60%)`, 
          life: 80 + Math.random()*40
        });
      }
      function draw() {
        ctx.clearRect(0,0,c.width,c.height);
        particles.forEach((p, i) => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
          ctx.fillStyle = p.color;
          ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
          if(p.life <= 0) particles.splice(i, 1);
        });
        if(particles.length > 0) requestAnimationFrame(draw);
      }
      draw();
    }

    // Init App
    initDB();
    initDate(activeDate);
    router('hub');

  </script>
</body>
</html>
